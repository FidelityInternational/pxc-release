<%=
  cluster_ips = link('mysql').instances.map { |instance| instance.address }
  galera_agent_port = link('mysql').p('galera_agent.port')
  mysql_port = link('mysql').p('port')

  proxy_uris = []
  if_p('pxc.proxy.api_uri') do |api_uri|
    proxy_uris = link('proxy').instances.map do |instance|
      "#{instance.index}-#{api_uri}"
    end
  end

  backends = cluster_ips.map.with_index do |ip, n|
    {
      Host: ip,
      Port: mysql_port,
      StatusPort: galera_agent_port,
      StatusEndpoint: 'api/v1/status',
      Name: "backend-#{n}"
    }
  end

  config = {
    API: {
      ProxyURIs: proxy_uris,
      Port: p('pxc.proxy.api_port'),
      AggregatorPort: p('pxc.proxy.api_aggregator_port'),
      ForceHttps: p('pxc.proxy.api_force_https'),
      Username: p('pxc.proxy.api_username'),
      Password: p('pxc.proxy.api_password')
    },
    Proxy: {
      Port: p('pxc.proxy.port'),
      HealthcheckTimeoutMillis: p('pxc.proxy.healthcheck_timeout_millis'),
      ShutdownDelaySeconds: p('pxc.proxy.shutdown_delay'),
      Backends: backends,
    },
    HealthPort: p('pxc.proxy.health_port'),
    Profiling: {
      Enabled: p('pxc.proxy.profiling_enabled'),
      Port: 6060
    },
    StaticDir: '/var/vcap/packages/proxy/static',
    PidFile: '/var/vcap/sys/run/proxy/proxy.pid'

  }

  if p('pxc.proxy.consul_enabled')
    config[:ConsulCluster] = 'http://127.0.0.1:8500'
    config[:ConsulServiceName] = p('pxc.proxy.consul_service_name')
  end

  JSON.pretty_generate(config)
%>
